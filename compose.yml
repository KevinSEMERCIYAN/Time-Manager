services:
  db:
    image: mariadb:11
    environment:
      TZ: "Europe/Paris"
      MARIADB_ROOT_PASSWORD: root
      MARIADB_DATABASE: timemanager
      MARIADB_USER: timemanager
      MARIADB_PASSWORD: timemanager
    volumes:
      - db-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "127.0.0.1", "-uroot", "-proot"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped

  backend:
    build: ./backend
    environment:
      TZ: "Europe/Paris"
      DATABASE_URL: mysql://timemanager:timemanager@db:3306/timemanager
      SHADOW_DATABASE_URL: mysql://root:root@db:3306/timemanager_shadow
      DB_HOST: db
      DB_PORT: "3306"
      DB_NAME: timemanager
      DB_USER: timemanager
      DB_PASS: timemanager

      LDAP_URL: ldaps://AD-01.primebank.local:636
      LDAP_BASE_DN: DC=primebank,DC=local
      LDAP_BIND_DN: administrateur@primebank.local
      LDAP_BIND_PASSWORD: "${LDAP_BIND_PASSWORD}"
      LDAP_USER_FILTER: "(sAMAccountName={{username}})"
      LDAP_CA_CERT_PATH: /app/certs/primebank-root-ca.cer
      LDAP_TLS_SERVERNAME: AD-01.primebank.local
      LDAP_DIRECT_BIND: "true"
      LDAP_UPN_DOMAIN: primebank.local
      AD_DERIVE_TEAM: "false"
      LDAP_USERS_BASE_DN: "OU=Utilisateurs,DC=primebank,DC=local"
      LDAP_USERS_FILTER: "(&(objectClass=user)(!(objectClass=computer)))"
      LDAP_SYNC_EXCLUDE_USERS: "svc_timemanager,svc_ldap_reader"
      AD_SYNC_ENABLED: "true"
      AD_SYNC_INTERVAL_MINUTES: "2"

      JWT_SECRET: "${JWT_SECRET}"
      JWT_TTL_MINUTES: "15"
      REFRESH_TTL_DAYS: "14"
      COOKIE_SECURE: "false"

      MAIL_HOST: mailpit
      MAIL_PORT: "1025"
      MAIL_FROM: no-reply@primebank.local

      # Connexion sans LDAP en local (d√©sactiver en prod)
      DEV_AUTH: "true"
      DEV_AUTH_USER: "dev"
      DEV_AUTH_PASSWORD: "dev"
    depends_on:
      db:
        condition: service_healthy
    expose:
      - "3000"
    restart: unless-stopped

  frontend:
    build: ./frontend
    expose:
      - "5173"
    restart: unless-stopped

  reverse-proxy:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      - frontend
      - backend
    restart: unless-stopped

  mailpit:
    image: axllent/mailpit:latest
    ports:
      - "8025:8025"
    restart: unless-stopped

volumes:
  db-data:
